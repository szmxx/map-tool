<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vue Map 标绘工具</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.css" rel="stylesheet" />
    <link href="https://unpkg.com/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.css" rel="stylesheet" />
    <style>
      * { box-sizing: border-box; }
      body { margin: 0; font-family: Inter, -apple-system, sans-serif; }
      #app { height: 100vh; }
      .layout { display: grid; grid-template-columns: 320px 1fr; height: 100%; }
      .panel { padding: 14px; border-right: 1px solid #e5e7eb; overflow: auto; background: #f8fafc; }
      .tools { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 8px; }
      .btn { border: 1px solid #cbd5e1; background: #fff; border-radius: 8px; padding: 8px; cursor: pointer; }
      .btn.active { background: #2563eb; border-color: #2563eb; color: #fff; }
      .btn:disabled { opacity: .45; cursor: not-allowed; }
      label { display: block; margin: 8px 0; font-size: 13px; }
      input, select { width: 100%; margin-top: 4px; padding: 6px; }
      #map { width: 100%; height: 100%; }
      .history { display:flex; gap:8px; margin-top: 10px; }
      h3 { margin-bottom: 6px; }
      p { color:#2563eb; font-size: 13px; }
    </style>
  </head>
  <body>
    <div id="app"></div>

    <script type="module">
      import { createApp, reactive, ref, computed, onMounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
      import { createRouter, createWebHashHistory, RouterView } from 'https://unpkg.com/vue-router@4/dist/vue-router.esm-browser.js';
      import { createPinia, defineStore } from 'https://unpkg.com/pinia@3/dist/pinia.esm-browser.js';
      import mapboxgl from 'https://esm.sh/mapbox-gl@3.10.0';
      import MapboxDraw from 'https://esm.sh/mapbox-gl-draw@1.5.0';
      import * as turf from 'https://esm.sh/@turf/turf@7.2.0';

      const usePlotStore = defineStore('plot', {
        state: () => ({ activeTool: 'none', selectedId: '', undoStack: [], redoStack: [] }),
        actions: {
          snapshot(current) { this.undoStack.push(current); this.redoStack = []; if (this.undoStack.length > 80) this.undoStack.shift(); },
          undo(current) { if (this.undoStack.length < 2) return null; this.redoStack.push(current); this.undoStack.pop(); return this.undoStack.at(-1); },
          redo(current) { if (!this.redoStack.length) return null; const next = this.redoStack.pop(); this.undoStack.push(current); return next; }
        }
      });

      const Home = {
        setup() {
          const store = usePlotStore();
          const mapRef = ref(null);
          const map = ref(null);
          const draw = ref(null);
          const msg = ref('就绪');
          const style = reactive({ color: '#ff4d4f', size: 1, text: '文字标注', rotate: 30, scale: 1.2 });
          const tools = [
            ['点','point'],['线','line'],['面','polygon'],['图标','icon'],['文字','text'],['箭头','arrow'],['作战箭头','battleArrow']
          ];

          const commit = () => store.snapshot(JSON.stringify(draw.value.getAll()));
          const apply = (json) => { draw.value.deleteAll(); JSON.parse(json).features.forEach(f => draw.value.add(f)); };

          const selectTool = (tool) => {
            store.activeTool = tool;
            const modeMap = { point:'draw_point', icon:'draw_point', text:'draw_point', line:'draw_line_string', arrow:'draw_line_string', battleArrow:'draw_line_string', polygon:'draw_polygon' };
            draw.value.changeMode(modeMap[tool] || 'simple_select');
            msg.value = `当前工具：${tool}`;
          };

          const setProps = () => {
            if (!store.selectedId) return;
            ['color','size'].forEach(k => draw.value.setFeatureProperty(store.selectedId, k, style[k]));
            draw.value.setFeatureProperty(store.selectedId, 'label', style.text);
            commit();
          };

          const transform = (kind) => {
            const id = store.selectedId; if (!id) return;
            const feature = draw.value.get(id); if (!feature) return;
            const center = turf.center(feature).geometry.coordinates;
            const transformed = kind === 'rotate' ? turf.transformRotate(feature, Number(style.rotate), { pivot: center }) : turf.transformScale(feature, Number(style.scale), { origin: center });
            transformed.id = id;
            draw.value.add(transformed);
            commit();
          };

          const doUndo = () => { const prev = store.undo(JSON.stringify(draw.value.getAll())); if (prev) apply(prev); };
          const doRedo = () => { const next = store.redo(JSON.stringify(draw.value.getAll())); if (next) apply(next); };

          onMounted(() => {
            mapboxgl.accessToken = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejlyd3NnMDAyemYycXA4dm50aHJ5Z3gifQ._A';
            map.value = new mapboxgl.Map({ container: mapRef.value, style: 'mapbox://styles/mapbox/streets-v12', center: [116.4,39.9], zoom: 8 });
            draw.value = new MapboxDraw({ displayControlsDefault: false, controls: { trash: true } });
            map.value.addControl(draw.value);
            map.value.addControl(new mapboxgl.NavigationControl(), 'top-right');

            map.value.on('draw.create', (e) => {
              const f = e.features[0];
              const id = String(f.id);
              draw.value.setFeatureProperty(id, 'color', style.color);
              draw.value.setFeatureProperty(id, 'size', style.size);
              draw.value.setFeatureProperty(id, 'label', style.text);

              if (store.activeTool === 'arrow' || store.activeTool === 'battleArrow') {
                const width = store.activeTool === 'battleArrow' ? 0.8 : 0.3;
                const poly = turf.buffer(f, width, { units: 'kilometers' });
                poly.id = id;
                draw.value.add(poly);
                draw.value.delete(id);
              }

              store.selectedId = id;
              commit();
            });

            map.value.on('draw.update', commit);
            map.value.on('draw.delete', commit);
            map.value.on('draw.selectionchange', (e) => { store.selectedId = e.features[0]?.id ? String(e.features[0].id) : ''; });
            commit();
          });

          return { mapRef, tools, store, style, msg, selectTool, setProps, transform, doUndo, doRedo, canUndo: computed(() => store.undoStack.length > 1), canRedo: computed(() => store.redoStack.length > 0) };
        },
        template: `
          <div class="layout">
            <aside class="panel">
              <h2>标绘工具面板</h2>
              <div class="tools">
                <button v-for="item in tools" :key="item[1]" class="btn" :class="{active: store.activeTool===item[1]}" @click="selectTool(item[1])">{{ item[0] }}</button>
              </div>
              <h3>属性调整</h3>
              <label>颜色<input type="color" v-model="style.color" @change="setProps"></label>
              <label>大小<input type="range" min="0.4" max="5" step="0.2" v-model.number="style.size" @change="setProps"></label>
              <label>文字<input v-model="style.text" @change="setProps" placeholder="输入标注文字"></label>
              <h3>编辑变换</h3>
              <label>旋转角度<input type="number" v-model.number="style.rotate"></label>
              <button class="btn" @click="transform('rotate')">旋转</button>
              <label>缩放倍数<input type="number" min="0.2" step="0.1" v-model.number="style.scale"></label>
              <button class="btn" @click="transform('scale')">缩放</button>
              <div class="history">
                <button class="btn" :disabled="!canUndo" @click="doUndo">撤销</button>
                <button class="btn" :disabled="!canRedo" @click="doRedo">重做</button>
              </div>
              <p>{{ msg }}</p>
              <small>平移：选中要素后，直接拖动要素或控制点即可。</small>
            </aside>
            <section id="map" ref="mapRef"></section>
          </div>`
      }

      const router = createRouter({ history: createWebHashHistory(), routes: [{ path: '/', component: Home }] });
      const app = createApp({ components: { RouterView }, template: '<RouterView />' });
      app.use(createPinia());
      app.use(router);
      app.mount('#app');
    </script>
  </body>
</html>
